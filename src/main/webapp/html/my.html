<html>
<head>
    <title>RPG</title>
    <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
    <link href="/css/my.css" rel="stylesheet">
</head>
<body>
<h1>RPG admin panel</h1>
<h3>Accounts list:</h3>
<label for="countPerPage">Count per page:</label>
<select name="countPerPage" id="countPerPage" onchange="redrawInfo()">
    <option value="3">3</option>
    <option value="5">5</option>
    <option value="10">10</option>
    <option value="20">20</option>
</select>
<table id="accountTable" border="1">
    <tr>
        <th>#</th>
        <th>Name</th>
        <th>Title</th>
        <th>Race</th>
        <th>Profession</th>
        <th>Level</th>
        <th>Birthday</th>
        <th>Banned</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
</table>
<div id="pagesButtons">Pages:</div>
<script>
    const races = [
        "HUMAN",
        "DWARF",
        "ELF",
        "GIANT",
        "ORC",
        "TROLL",
        "HOBBIT"
    ];

    const professions = [
        "WARRIOR",
        "ROGUE",
        "SORCERER",
        "CLERIC",
        "PALADIN",
        "NAZGUL",
        "WARLOCK",
        "DRUID"
    ];

    const banned = [
        "true",
        "false"
    ];


    //Get players list from backEnd
    function drawPlayersList(pageNumber, pageSize) {
        let accountTable = document.getElementById("accountTable");
        accountTable.innerHTML = '';

        let playersListURI = "/rest/players?pageNumber=" + pageNumber + "&pageSize=" + pageSize;
        $.getJSON(playersListURI, {
            format: "json"
        })
            .done(function (playersList) {
                $(function () {
                    $.each(playersList, function (i, item) {
                        var $tr = $('<tr>').append(
                            $('<td>').text(item.id).attr("name", "id"),
                            $('<td>').text(item.name).attr("name", "name"),
                            $('<td>').text(item.title).attr("name", "title"),
                            $('<td>').text(item.race).attr("name", "race"),
                            $('<td>').text(item.profession).attr("name", "profession"),
                            $('<td>').text(item.level).attr("name", "level"),
                            $('<td>').text(item.birthday).attr("name", "birthday"),
                            $('<td>').text(item.banned).attr("name", "banned"),
                            $('<td>').append($('<img>').attr("src", "/img/edit.png").attr("name", "edit")),
                            $('<td>').append($('<img>').attr("src", "/img/delete.png").attr("name", "delete"))
                        ).appendTo('#accountTable');

                        $tr.html()
                    });
                });
            });
    }


    //Get total account count
    function getTotalAccounts() {
        let totalAccountsURI = "/rest/players/count";

        let out;

        $.ajax({
            async: false,
            url: totalAccountsURI,
            type: "GET",
            cache: false
        }).done(function (totalAccs) {
            out = totalAccs;
        });

        return out;
    }


    //Calculate total pages
    function calculateTotalPages() {
        let countPerPage = document.getElementById("countPerPage");

        let pageSize = countPerPage.value;

        let totalAccounts = getTotalAccounts();

        let out;

        if (totalAccounts === 1) {
            out = 1;
        } else if (totalAccounts < pageSize) {
            out = 1;
        } else if ((totalAccounts % pageSize) === 0) {
            out = totalAccounts / pageSize;
        } else {
            out = totalAccounts / pageSize;
            out = Math.floor(out);
            out++;
        }

        return out;
    }


    let pickedPageNumber = 1;

    //Add buttons under table to navigate between pages
    function addPageButtons(totalPages) {
        let buttonsElement = document.getElementById("pagesButtons");

        buttonsElement.innerHTML = '';

        for (let i = 1; i < totalPages + 1; i++) {
            let button = document.createElement("BUTTON");
            button.value = i;
            button.name = "pageButton";
            button.setAttribute("picked", "false");
            button.innerHTML = "" + i;
            button.style.color = "000000";

            buttonsElement.appendChild(button);
        }

        let button = document.querySelector("#pagesButtons > [value='" + pickedPageNumber + "']");
        button.style.color = "ff9900";
        button.setAttribute("picked", "true");
    }


    window.onload = function () {
        redrawInfo();
    }


    function redrawInfo() {
        let totalPages = calculateTotalPages();
        addPageButtons(totalPages);

        let rowsPerPage = document.getElementById("countPerPage");
        let pageSize = rowsPerPage.value;
        drawPlayersList(pickedPageNumber - 1, pageSize);
    }


    function changePage() {
        let rowsPerPage = document.getElementById("countPerPage");
        let pageSize = rowsPerPage.value;

        drawPlayersList(pickedPageNumber - 1, pageSize);
        let oldPick = document.querySelector("#pagesButtons > [picked='true']");
        oldPick.setAttribute("picked", "false");
        oldPick.style.color = "000000";

        let newPick = document.querySelector("#pagesButtons > [value='" + pickedPageNumber + "']");
        newPick.setAttribute("picked", "true");
        newPick.style.color = "ff9900";
    }


    function deleteById(id) {
        let totalAccountsURI = "/rest/players/" + id;
        $.ajax({
            async: false,
            url: totalAccountsURI,
            type: "DELETE",
            cache: false
        }).done(function () {
            let rowsPerPage = document.getElementById("countPerPage");
            let pageSize = rowsPerPage.value;
            let pageHaveRows = checkPageHaveRows(pickedPageNumber - 1, pageSize);

            if (pageHaveRows) {
                drawPlayersList(pickedPageNumber - 1, pageSize);
                let totalPages = calculateTotalPages();
                addPageButtons(totalPages);
            } else {
                pickedPageNumber--;
                redrawInfo();
            }
        });
    }


    function checkPageHaveRows(pageNumber, pageSize) {
        let playersListURI = "/rest/players?pageNumber=" + pageNumber + "&pageSize=" + pageSize;

        let out;

        $.ajax({
            async: false,
            url: playersListURI,
            type: "GET",
            cache: false
        }).done(function (playersList) {
            out = !(playersList.length === 0);
        });

        return out;
    }


    function editById(id) {
        let xpath = "//td[text()='" + id + "']";
        let idField = document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;

        let row = idField.parentElement;
        let deleteButton = row.querySelector('[name="delete"]');
        deleteButton.style.visibility = 'hidden';

        let editButton = row.querySelector('[name="edit"]');
        editButton.setAttribute("src", "/img/save.png");
        editButton.setAttribute("name", "save");

        let nameField = row.querySelector('[name="name"]');
        nameField.setAttribute("contentEditable", "true");

        let titleField = row.querySelector('[name="title"]');
        titleField.setAttribute("contentEditable", "true");

        let raceField = row.querySelector('[name="race"]');
        addPickRaceForField(raceField, id);

        let professionField = row.querySelector('[name="profession"]');
        addPickProfessionForField(professionField, id);

        let bannedField = row.querySelector('[name="banned"]');
        addPickBannedForField(bannedField, id);
    }


    function saveById(id) {
        let outJSON = getRowData(id);
        updateRowToServer(id, outJSON);

        let rowsPerPage = document.getElementById("countPerPage");
        let pageSize = rowsPerPage.value;
        drawPlayersList(pickedPageNumber - 1, pageSize);
    }


    function getRowData(id){
        let xpath = "//td[text()='" + id + "']";
        let idField = document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
        let row = idField.parentElement;

        let output = {};
        let nameField = row.querySelector('[name="name"]');
        output.name = nameField.textContent;

        let titleField = row.querySelector('[name="title"]');
        output.title = titleField.textContent;

        let raceField = row.querySelector('[name="race"]');
        let raceSelector = raceField.querySelector('[id=raceSelector' + id + ']');
        output.race = raceSelector.value;

        let professionField = row.querySelector('[name="profession"]');
        let professionSelector = professionField.querySelector('[id=professionSelector' + id + ']');
        output.profession = professionSelector.value;

        let bannedField = row.querySelector('[name="banned"]');
        let bannedSelector = bannedField.querySelector('[id=bannedSelector' + id + ']');
        output.banned = bannedSelector.value;

        return JSON.stringify(output);
    }


    function updateRowToServer(id, json){
        let updateURI = "/rest/players/" + id;
        $.ajax({
            async: false,
            url: updateURI,
            type: "POST",
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            data: json,
            cache: false
        });
    }

    function addPickRaceForField(raceField, id){
        let currentRace = raceField.textContent;
        raceField.textContent = null;

        let $select = $('<select>')
            .attr("id", "raceSelector" + id)
            .appendTo(raceField);

        (function () {
            $(function () {
                $.each(races, function (i, item) {
                    if(currentRace === item){
                        $('<option>').text(item).attr("value", "" + item + "").attr("selected", "selected")
                            .appendTo($select);
                    } else {
                        $('<option>').text(item).attr("value", "" + item + "")
                            .appendTo($select);
                    }
                });
            });
        })();

        $select.html();
    }


    function addPickProfessionForField(professionField, id){
        let currentProfession = professionField.textContent;
        professionField.textContent = null;

        let $select = $('<select>')
            .attr("id", "professionSelector" + id)
            .appendTo(professionField);

        (function () {
            $(function () {
                $.each(professions, function (i, item) {
                    if(currentProfession === item){
                        $('<option>').text(item).attr("value", "" + item + "").attr("selected", "selected")
                            .appendTo($select);
                    } else {
                        $('<option>').text(item).attr("value", "" + item + "")
                            .appendTo($select);
                    }
                });
            });
        })();

        $select.html();
    }


    function addPickBannedForField(bannedField, id){
        let currentBanned = bannedField.textContent;
        bannedField.textContent = null;

        let $select = $('<select>')
            .attr("id", "bannedSelector" + id)
            .appendTo(bannedField);

        (function () {
            $(function () {
                $.each(banned, function (i, item) {
                    if(currentBanned === item){
                        $('<option>').text(item).attr("value", "" + item + "").attr("selected", "selected")
                            .appendTo($select);
                    } else {
                        $('<option>').text(item).attr("value", "" + item + "")
                            .appendTo($select);
                    }
                });
            });
        })();

        $select.html();
    }


    document.addEventListener('click', function (e) {
        if (e.target && e.target.name === 'pageButton') {
            pickedPageNumber = e.target.value;
            changePage();
        }
    });


    document.addEventListener('click', function (e) {
        if (e.target && e.target.name === 'delete') {
            let id = e.target.parentElement.closest("tr").querySelector('[name="id"]').textContent;
            deleteById(id);
        }
    });


    document.addEventListener('click', function (e) {
        if (e.target && e.target.name === 'save') {
            let id = e.target.parentElement.closest("tr").querySelector('[name="id"]').textContent;
            saveById(id);
        }
    });


    document.addEventListener('click', function (e) {
        if (e.target && e.target.name === 'edit') {
            let id = e.target.parentElement.closest("tr").querySelector('[name="id"]').textContent;
            editById(id);
        }
    });

</script>
</body>
</html>